<!DOCTYPE html> 
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Hello, World</title>
        <link href="jquery-mobile/jquery.mobile-1.2.0.min.css" rel="stylesheet" type="text/css" />
        <link href="styles/main.css" rel="stylesheet" type="text/css" />

        <script src="cordova.js" type="text/javascript"></script>
        <script src="jquery-mobile/jquery-1.8.2.min.js" type="text/javascript"></script>
        <script src="jquery-mobile/jquery.mobile-1.2.0.min.js" type="text/javascript"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <style type="text/css">
	html {height: 100%}
	body {height: 100%; margin:0; padding:0}
	#map_canvas {height: 100%}
</style>
    
<script type="text/javascript" charset="utf-8">

    document.addEventListener("deviceready", onDeviceReady, false);

    var watchID = null;

    // Cordova is ready
    //
    function onDeviceReady() {
        // Throw an error if no update is received every 30 seconds
        var options = { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true, frequency: 100  };
        watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
    }

    // onSuccess Geolocation
    //
    var late = null;
    var longe = null;
    
    
    function onSuccess(position) {
        late = position.coords.latitude
        longe = position.coords.longitude
        
        var element = document.getElementById('geolocation');
         element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
                            'Longitude: '          + position.coords.longitude             + '<br />' +
                            'Altitude: '           + position.coords.altitude              + '<br />' +
                            'Accuracy: '           + position.coords.accuracy              + '<br />' +
                            'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
                            'Heading: '            + position.coords.heading               + '<br />' +
                            'Speed: '              + position.coords.speed                 + '<br />' +
                            'Timestamp: '          + new Date(position.timestamp)          + '<br />'
        
        
        
        $("#lat").val(position.coords.latitude);
        $("#long").val(position.coords.longitude);
        
        MoveMarkerAndCircle(late, longe);
        map.setCenter(myLocationMarker.getPosition()); 
        }

          // clear the watch that was started earlier
   
    // 
    function clearWatch() {
        if (watchID != null) {
            navigator.geolocation.clearWatch(watchID);
            watchID = null;
        }
    }

    // onError Callback receives a PositionError object
    //
    function onError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }  
    
// globals
var watchID = null;
var map = null;
var myLocationMarker = null;
var searchCircle = null;
var myLocation = null;
	
function onLoad() {
	startGPS();
}

function onUnLoad() {
	console.log("clearing watch " + watchID);
}
    
function startGPS() {
	// simulate getting position from GPS
	myLocation = new google.maps.LatLng(late, longe);
	
	// create Google map
  var mapOptions = {
    zoom: 16,
    center: new google.maps.LatLng(-19.9292649541961, -43.932059362934),
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControl: false,
    streetViewControl: false,
  };
  var rendererOptions = {	draggable: false	};
	map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
	google.maps.event.trigger(map, 'resize');
	
	myLocationMarker = new google.maps.Marker({
		title: 'This is me!',
		zIndex: 90,
		optimized: false,
		map:map,
		position: myLocation
	});		

	searchCircle = new google.maps.Circle({
		fillColor: '#c0e4dd',
		strokeColor: '#f15f22',
		fillOpacity: 0.5,
		radius: 100,
		map:map,
		center:myLocation
	});
	// using bindTo instead does not fix the problem
//	searchCircle.bindTo('center', myLocationMarker, 'position'); //This will set the circle bound to the marker at center
}

var MoveMarkerAndCircle = function(lat, lng) {
	
    myLocation = new google.maps.LatLng(lat, lng);
	myLocationMarker.setPosition(myLocation);
	
	searchCircle.setCenter(myLocation);
}

    
    var GenerateFakeMovement = function() {
	MoveMarkerAndCircle(late, longe);      
}
</script>
</head>
<body  style="height:100%;text-align:center" onunload="onUnLoad()" onload="startGPS()">
	<div id="map_canvas" style="width: 100%;height:300px"></div>
	<Button href='#' onclick="GenerateFakeMovement();" style="padding-top:5px">MOVE MARKER AND CIRCLE</Button>
    <div id="geolocation"></div>
</body>
</html>